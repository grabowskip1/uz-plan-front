<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wspólne przerwy ID ↔ BT</title>
  <link rel="manifest" href="manifest.json">
  <!-- usuń tę linię, jeśli nie masz pliku -->
  <link rel="icon" href="icons/icon-192.png" />
  <meta name="theme-color" content="#ffffff">
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    table{border-collapse:collapse;width:100%;table-layout:fixed}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;word-wrap:break-word}
    th{background:#f5f5f5}
    caption{margin-bottom:12px;font-weight:600}
    small{color:#666}
    .muted{color:#888;font-size:12px}
    .tag{display:inline-block;border:1px solid #bbb;border-radius:6px;padding:2px 6px;margin:2px;font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <h1>Wspólne przerwy ID ↔ BT</h1>
  <div id="meta" class="muted"></div>

  <table id="grid">
    <caption>Tydzień <span id="week"></span></caption>
    <thead>
      <tr>
        <th></th>
        <th>Poniedziałek</th>
        <th>Wtorek</th>
        <th>Środa</th>
        <th>Czwartek</th>
        <th>Piątek</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <p><small>Źródło: plan.uz.zgora.pl (ID: 30197, BT: 30214, słownik: 2467). Odświeżanie po stronie Workera.</small></p>

<script>
const WORKER_BASE = "https://YOUR-WORKER-SUBDOMAIN.workers.dev"; // ← podmień
const GROUPS = { ID: "30197", BT: "30214", CAL: "2467" };
const DAYS = ["Poniedziałek","Wtorek","Środa","Czwartek","Piątek"];

main();

async function main(){
  registerSW();

  const tz = "Europe/Warsaw";
  const [idData, btData] = await Promise.all([
    fetch(`${WORKER_BASE}/parseUZ?id=${GROUPS.ID}&cal=${GROUPS.CAL}&tz=${tz}`).then(r=>r.json()),
    fetch(`${WORKER_BASE}/parseUZ?id=${GROUPS.BT}&cal=${GROUPS.CAL}&tz=${tz}`).then(r=>r.json()),
  ]);

  const week = nextWeekRangePL();
  document.getElementById("week").textContent = `${week.mon}–${week.fri}`;
  document.getElementById("meta").textContent = `Tydzień zaczynający się ${week.mon} (PL).`;

  // przygotuj dane dzienne
  const dayData = [];
  for (let d=0; d<5; d++){
    const busyID = (idData.days?.[String(d)] ?? []).map(([s,e])=>({start:s,end:e}));
    const busyBT = (btData.days?.[String(d)] ?? []).map(([s,e])=>({start:s,end:e}));

    const startID = busyID[0]?.start || null;
    const startBT = busyBT[0]?.start || null;
    const endID = busyID.length ? busyID[busyID.length-1].end : null;
    const endBT = busyBT.length ? busyBT[busyBT.length-1].end : null;

    const brID = toBreaks(busyID);
    const brBT = toBreaks(busyBT);
    const common = intersectBreaks(brID, brBT, 10); // >= 10 min

    dayData.push({ startID, startBT, endID, endBT, common });
  }

  // zbuduj tbody z dynamiczną liczbą wierszy "Przerwa"
  const maxBreaks = Math.max(0, ...dayData.map(x=>x.common.length));
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  // wiersz startów
  tbody.appendChild(row("Zaczynamy o", d => fmtPair(dayData[d].startID, dayData[d].startBT)));

  // wiersze przerw
  for (let i=0; i<maxBreaks; i++){
    tbody.appendChild(row("Przerwa", d => {
      const br = dayData[d].common[i];
      return br ? tag(`${br.start}–${br.end}`) : "—";
    }));
  }
  if (maxBreaks === 0){
    // gdy brak przerw w całym tygodniu, dodaj jeden wiersz z kreskami
    tbody.appendChild(row("Przerwa", _ => "—"));
  }

  // wiersz końców
  tbody.appendChild(row("Koniec", d => fmtPair(dayData[d].endID, dayData[d].endBT)));
}

// ==== rendering helpers ====
function row(label, cellFn){
  const tr = document.createElement("tr");
  const th = document.createElement("th");
  th.textContent = label;
  tr.appendChild(th);
  for (let d=0; d<5; d++){
    const td = document.createElement("td");
    const val = cellFn(d);
    if (typeof val === "string") td.textContent = val;
    else td.appendChild(val);
    tr.appendChild(td);
  }
  return tr;
}
function tag(text){
  const span = document.createElement("span");
  span.className = "tag";
  span.textContent = text;
  return span;
}
function fmtPair(a,b){
  const A = a?`(ID - ${a})`:"(ID - —)";
  const B = b?`(BT - ${b})`:"(BT - —)";
  return `${A} ${B}`;
}

// ==== time utils ====
function toBreaks(slots){
  if (!slots || slots.length<2) return [];
  const out=[];
  for (let i=0;i<slots.length-1;i++){
    const a=slots[i], b=slots[i+1];
    if (toMin(b.start)>toMin(a.end)) out.push({start:a.end, end:b.start});
  }
  return out;
}
function intersectBreaks(A,B,minMin){
  const out=[]; let i=0,j=0;
  while(i<A.length && j<B.length){
    const s = Math.max(toMin(A[i].start), toMin(B[j].start));
    const e = Math.min(toMin(A[i].end),   toMin(B[j].end));
    if (e - s >= minMin) out.push({start:fromMin(s), end:fromMin(e)});
    if (toMin(A[i].end) < toMin(B[j].end)) i++; else j++;
  }
  return out;
}
function toMin(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }
function fromMin(m){ const h=String(Math.floor(m/60)).padStart(2,"0"), mm=String(m%60).padStart(2,"0"); return `${h}:${mm}`; }

// zawsze najbliższy PON jako start tygodnia (Mon–Fri)
function nextWeekRangePL(){
  const tz="Europe/Warsaw";
  const now = new Date();
  const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'}).formatToParts(now);
  const o = Object.fromEntries(parts.map(p=>[p.type,p.value]));
  const wdShort = (o.weekday||"mon").toLowerCase().slice(0,3);
  const idx = {mon:1,tue:2,wed:3,thu:4,fri:5,sat:6,sun:7}[wdShort] ?? 1;
  const today = new Date(`${o.year}-${o.month}-${o.day}T00:00:00`);
  const daysToNextMon = (8 - idx) % 7 || 7; // zawsze „następny” pon
  const mon = addDays(today, daysToNextMon);
  const fri = addDays(mon,4);
  return { mon: iso(mon), fri: iso(fri) };
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function iso(d){ return d.toISOString().slice(0,10); }

// SW
function registerSW(){
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
}
</script>
</body>
</html>
