<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wspólne przerwy ID ↔ BT</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icons/icon-192.png" />
  <meta name="theme-color" content="#ffffff">
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    table{border-collapse:collapse;width:100%;table-layout:fixed}
    th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;word-wrap:break-word}
    th{background:#f5f5f5}
    caption{margin-bottom:12px;font-weight:600}
    small{color:#666}
    .muted{color:#888;font-size:12px}
    .tag{display:inline-block;border:1px solid #bbb;border-radius:6px;padding:2px 6px;margin:2px;font-variant-numeric:tabular-nums}
  </style>
</head>
<body>
  <h1>Wspólne przerwy ID ↔ BT</h1>
  <div id="meta" class="muted"></div>

  <table id="grid">
    <caption>Tydzień <span id="week"></span></caption>
    <thead>
      <tr>
        <th></th>
        <th>Poniedziałek</th>
        <th>Wtorek</th>
        <th>Środa</th>
        <th>Czwartek</th>
        <th>Piątek</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>Zaczynamy o</th>
        <td id="s0"></td><td id="s1"></td><td id="s2"></td><td id="s3"></td><td id="s4"></td>
      </tr>
      <tr>
        <th>Przerwa</th>
        <td id="b0"></td><td id="b1"></td><td id="b2"></td><td id="b3"></td><td id="b4"></td>
      </tr>
      <tr>
        <th>Przerwa</th>
        <td id="b0b"></td><td id="b1b"></td><td id="b2b"></td><td id="b3b"></td><td id="b4b"></td>
      </tr>
      <tr>
        <th>Koniec</th>
        <td id="e0"></td><td id="e1"></td><td id="e2"></td><td id="e3"></td><td id="e4"></td>
      </tr>
    </tbody>
  </table>

  <p><small>Źródło: plan.uz.zgora.pl (ID: 30197, BT: 30214, słownik: 2467). Odświeżanie po stronie Workera.</small></p>

<script>
const WORKER_BASE = "https://uz-plan.grabowski-piotrekk.workers.dev"; // ← podmień
const GROUPS = { ID: "30197", BT: "30214", CAL: "2467" };
const DAYS = ["Poniedziałek","Wtorek","Środa","Czwartek","Piątek"];

main();

async function main(){
  registerSW();

  const tz = "Europe/Warsaw";
  const [idData, btData] = await Promise.all([
    fetch(`${WORKER_BASE}/parseUZ?id=${GROUPS.ID}&cal=${GROUPS.CAL}&tz=${tz}`).then(r=>r.json()),
    fetch(`${WORKER_BASE}/parseUZ?id=${GROUPS.BT}&cal=${GROUPS.CAL}&tz=${tz}`).then(r=>r.json()),
  ]);

  const week = nextWeekRangePL();
  document.getElementById("week").textContent = `${week.mon}–${week.fri}`;
  document.getElementById("meta").textContent = `Tydzień zaczynający się ${week.mon} (PL).`;

  for (let d=0; d<5; d++){
    const busyID = (idData.days?.[String(d)] ?? []).map(([s,e])=>({start:s,end:e}));
    const busyBT = (btData.days?.[String(d)] ?? []).map(([s,e])=>({start:s,end:e}));

    const startID = busyID[0]?.start || null;
    const startBT = busyBT[0]?.start || null;
    document.getElementById(`s${d}`).textContent = fmtStart(startID, startBT);

    const endID = busyID.length ? busyID[busyID.length-1].end : null;
    const endBT = busyBT.length ? busyBT[busyBT.length-1].end : null;
    document.getElementById(`e${d}`).textContent = fmtEnd(endID, endBT);

    const brID = toBreaks(busyID);
    const brBT = toBreaks(busyBT);
    const common = intersectBreaks(brID, brBT, 10); // min 10 min

    fillBreakCell(`b${d}`, common[0]);
    fillBreakCell(`b${d}b`, common[1]);
  }
}

function fillBreakCell(id, br){
  const el = document.getElementById(id);
  el.innerHTML = "";
  if (!br){ el.textContent = "—"; return; }
  const span = document.createElement("span");
  span.className = "tag";
  span.textContent = `${br.start}–${br.end}`;
  el.appendChild(span);
}

function fmtStart(a,b){
  const A = a?`(ID - ${a})`:"(ID - —)";
  const B = b?`(BT - ${b})`:"(BT - —)";
  return `${A} ${B}`;
}
function fmtEnd(a,b){
  const A = a?`(ID - ${a})`:"(ID - —)";
  const B = b?`(BT - ${b})`:"(BT - —)";
  return `${A} ${B}`;
}

function toBreaks(slots){
  if (!slots || slots.length<2) return [];
  const out=[];
  for (let i=0;i<slots.length-1;i++){
    const a=slots[i], b=slots[i+1];
    if (toMin(b.start)>toMin(a.end)) out.push({start:a.end, end:b.start});
  }
  return out;
}

function intersectBreaks(A,B,minMin){
  const out=[]; let i=0,j=0;
  while(i<A.length && j<B.length){
    const s = Math.max(toMin(A[i].start), toMin(B[j].start));
    const e = Math.min(toMin(A[i].end),   toMin(B[j].end));
    if (e - s >= minMin) out.push({start:fromMin(s), end:fromMin(e)});
    if (toMin(A[i].end) < toMin(B[j].end)) i++; else j++;
  }
  return out;
}

function toMin(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }
function fromMin(m){ const h=String(Math.floor(m/60)).padStart(2,"0"), mm=String(m%60).padStart(2,"0"); return `${h}:${mm}`; }

function nextWeekRangePL(){
  const tz="Europe/Warsaw";
  const now = new Date();
  const parts = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'}).formatToParts(now);
  const o = Object.fromEntries(parts.map(p=>[p.type,p.value]));
  const wd = ["sun","mon","tue","wed","thu","fri","sat"].indexOf((o.weekday||"mon").toLowerCase().slice(0,3));
  const dayIdx = wd===0?7:wd; // 1..7
  const today = new Date(`${o.year}-${o.month}-${o.day}T00:00:00`);
  const daysToNextMon = (8 - dayIdx) % 7 || 7;
  const mon = addDays(today, daysToNextMon);
  const fri = addDays(mon,4);
  return { mon: iso(mon), fri: iso(fri) };
}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function iso(d){ return d.toISOString().slice(0,10); }

function registerSW(){
  if ("serviceWorker" in navigator){
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  }
}
</script>
</body>
</html>
