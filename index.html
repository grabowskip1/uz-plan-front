<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wspólne przerwy</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="icon-512.png" />
  <style>
    :root{color-scheme:light dark}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#0b1220;color:#e5e7eb}
    header{padding:16px 20px;border-bottom:1px solid #243044;position:sticky;top:0;background:#0b1220}
    main{padding:16px 20px;max-width:1024px;margin:0 auto}
    .card{background:#111a2b;border:1px solid #243044;border-radius:16px;padding:16px;margin-top:16px}
    .grid{display:grid;grid-template-columns:160px repeat(5,1fr);gap:8px;align-items:start}
    .hl{font-weight:600}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #334155;margin-right:6px;margin-bottom:6px}
    .muted{opacity:.8}
    .small{font-size:12px}
  </style>
</head>
<body>
  <main>
    <div id="status" class="small muted"></div>
    <div id="results" class="card" style="display:none"></div>
  </main>
<script>
const WORKER_BASE = "https://uz-plan.grabowski-piotrekk.workers.dev/";
const GROUP_A = "30197";
const GROUP_B = "30214";
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
function parseTime(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
function minToStr(m){ return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60,'0'); }
function gapsFromLessons(slots){ const res=[]; if(slots.length<2) return res; for(let i=0;i<slots.length-1;i++){ const a=slots[i].end, b=slots[i+1].start; if(b-a>=10) res.push({start:a,end:b}); } return res; }
function intersectIntervals(A,B){ const out=[]; let i=0,j=0; while(i<A.length && j<B.length){ const s=Math.max(A[i].start,B[j].start), e=Math.min(A[i].end,B[j].end); if(e-s>=10) out.push({start:s,end:e}); if(A[i].end < B[j].end) i++; else j++; } return out; }
async function fetchPlan(id){ const r = await fetch(WORKER_BASE + '/parseUZ?id='+encodeURIComponent(id)+'&tz=Europe/Warsaw'); if(!r.ok) throw new Error('Błąd '+r.status); const j=await r.json(); const days={}; for(const k in j.days){ days[k]=j.days[k].map(([a,b])=>({start:parseTime(a),end:parseTime(b)})).sort((p,q)=>p.start-q.start);} return days; }
function renderTable(container, planA, planB){
  const daysIdx=[0,1,2,3,4]; const dayName=['Poniedziałek','Wtorek','Środa','Czwartek','Piątek'];
  let html='<div class="grid hl"><div></div>'+daysIdx.map(d=>'<div>'+dayName[d]+'</div>').join('')+'</div>';
  html+='<div class="grid"><div class="hl">Zaczynamy razem</div>';
  for(const d of daysIdx){
    const a=planA[d]||[], b=planB[d]||[]; const sA=a.length? a[0].start:null, sB=b.length? b[0].start:null;
    html += (sA!=null && sB!=null && Math.abs(sA-sB)<=30) ? '<div>( '+minToStr(sA)+' '+minToStr(sB)+' )</div>' : '<div class="muted">—</div>';
  }
  html+='</div>';
  html+='<div class="grid"><div class="hl">Przerwy</div>';
  for(const d of daysIdx){
    const ga=gapsFromLessons(planA[d]||[]), gb=gapsFromLessons(planB[d]||[]), ov=intersectIntervals(ga,gb);
    html += '<div>' + (ov.length? ov.map(x=>'<span class="tag">'+minToStr(x.start)+'–'+minToStr(x.end)+'</span>').join(' ') : '<span class="muted">—</span>') + '</div>';
  }
  html+='</div>';
  html+='<div class="grid"><div class="hl">Koniec</div>';
  for(const d of daysIdx){
    const a=planA[d]||[], b=planB[d]||[]; const eA=a.length? a[a.length-1].end:null, eB=b.length? b[b.length-1].end:null;
    html += '<div>(ID '+(eA?minToStr(eA):'—')+') (BT '+(eB?minToStr(eB):'—')+')</div>';
  }
  html+='</div>'; container.innerHTML=html; container.style.display='block';
}
async function boot(){
    const status = document.getElementById('status');
    const results = document.getElementById('results');
    try {
      const [A,B] = await Promise.all([fetchPlan("30197"), fetchPlan("30214")]);
      renderTable(results, A, B);
      status.textContent = 'Gotowe.';
    } catch(e) {
      status.textContent = 'Błąd: ' + (e.message||e);
    }
  }
  window.addEventListener('load', boot);
</script>
</body>
</html>
